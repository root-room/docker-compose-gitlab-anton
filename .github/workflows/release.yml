name: Validate and Release
env:
  VERSION_VAR: CURRENT_GITLAB_VERSION
  DOCKER_REPO: gitlab/gitlab-ee
on:
  pull_request:
    branches:
      - main
    paths:
      - 'tools/init.bash'
  push:
    branches:
      - main
    paths:
      - 'tools/init.bash'
permissions:
  contents: write
jobs:
  validate-version:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4
      - name: Validate CURRENT version format and Docker tag
        run: |
          APP_VERSION=$(grep -oP "^${VERSION_VAR}=\"\K[^\"]+" tools/init.bash)
          if [ -z "$APP_VERSION" ]; then
            echo "::error::Failed to parse ${VERSION_VAR}"
            exit 1
          fi
          URL="https://hub.docker.com/v2/repositories/${DOCKER_REPO}/tags/${APP_VERSION}"
          echo "Checking if tag ${DOCKER_REPO}:${APP_VERSION} exists on Docker Hub..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Tag '${APP_VERSION}' not found for image '${DOCKER_REPO}' on Docker Hub (HTTP ${HTTP_CODE}). Check ${VERSION_VAR}."
            exit 1
          fi
          echo "OK: Image ${DOCKER_REPO}:${APP_VERSION} exists on Docker Hub."
  release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4
      - name: Fetch tags
        run: git fetch --tags
      - name: Read version and prepare tag
        id: version
        run: |
          APP_VERSION=$(grep -oP "^${VERSION_VAR}=\"\K[^\"]+" tools/init.bash)
          if [ -z "$APP_VERSION" ]; then
            echo "ERROR: failed to parse ${VERSION_VAR}"
            exit 1
          fi
          TAG="v$APP_VERSION"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists â€” skipping release."
            exit 0
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
      - name: Create GitHub Release
        if: steps.version.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: false
