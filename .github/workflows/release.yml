name: Validate and Release
env:
  VERSION_VAR: CURRENT_GITLAB_VERSION
  DOCKER_REPO: gitlab/gitlab-ee
  ARCHIVE_NAME: ${{ github.event.repository.name }}

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  validate-version:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Validate CURRENT version format and Docker tag
        run: |
          APP_VERSION=$(grep -oP "^${VERSION_VAR}=\"\K[^\"]+" tools/init.bash)
          if [ -z "$APP_VERSION" ]; then
            echo "::error::Failed to parse ${VERSION_VAR}"
            exit 1
          fi

          URL="https://hub.docker.com/v2/repositories/${DOCKER_REPO}/tags/${APP_VERSION}"
          echo "Checking if tag ${DOCKER_REPO}:${APP_VERSION} exists on Docker Hub..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Tag '${APP_VERSION}' not found for image '${DOCKER_REPO}' on Docker Hub (HTTP ${HTTP_CODE})"
            exit 1
          fi

          echo "OK: Image ${DOCKER_REPO}:${APP_VERSION} exists on Docker Hub."

  release:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Fetch tags
        run: git fetch --tags

      - name: Read version and prepare tag
        id: version
        run: |
          APP_VERSION=$(grep -oP "^${VERSION_VAR}=\"\K[^\"]+" tools/init.bash)
          if [ -z "$APP_VERSION" ]; then
            echo "ERROR: failed to parse ${VERSION_VAR}"
            exit 1
          fi

          TAG_SUFFIX="+ldev"
          EXISTING_TAGS=$(git tag --list "${APP_VERSION}${TAG_SUFFIX}[0-9]*.[0-9]*" || true)

          MAJOR=0
          MINOR=1

          if [ -n "$EXISTING_TAGS" ]; then
            LAST_TAG=$(printf '%s\n' "$EXISTING_TAGS" \
              | sed -E "s|^${APP_VERSION}\+ldev([0-9]+)\.([0-9]+)$|\1 \2|" \
              | sort -n -k1,1 -k2,2 \
              | tail -n1)

            MAJOR=$(echo "$LAST_TAG" | awk '{print $1}')
            MINOR=$(echo "$LAST_TAG" | awk '{print $2}')
            MINOR=$((MINOR + 1))

            if [ "$MINOR" -ge 10 ]; then
              MINOR=0
              MAJOR=$((MAJOR + 1))
            fi
          fi

          TAG="${APP_VERSION}${TAG_SUFFIX}${MAJOR}.${MINOR}"
          echo "Next tag: $TAG"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists â€” aborting."
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Create release archive
        if: steps.version.outputs.tag != ''
        run: |
          ARCHIVE_NAME="${{ env.ARCHIVE_NAME }}"
          echo "Creating archive ${ARCHIVE_NAME}.tar.gz"
          git archive --format=tar.gz --output="${ARCHIVE_NAME}.tar.gz" HEAD

      - name: Create GitHub Release
        if: steps.version.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            ${{ env.ARCHIVE_NAME }}.tar.gz
